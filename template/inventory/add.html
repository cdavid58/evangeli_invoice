{% extends '../base.html' %}
{% block content %}

<div class="card mb-3" data-date="{{ i.registration_date }}">
  <div class="card-body p-2 overflow-hidden">
    <div class="row p-1">
      <div class="col-md-6 col-12">
        <h5>Crea un nuevo producto</h5>
      </div>
      <div class="col-md-3 ml-auto col-12 text-right">
        <button class="btn btn-info list_product">
        	<span class="nav-link-icon">
        		<span class="fas fa-chevron-left"></span>
        	</span>
        	<span class="nav-link-text ps-1">Lista de productos</span>
        </button>
      </div>
    </div>
  </div>
</div>

<form class="form_save_product">
	<div class="card mb-3">
		<div class="card-body">
		  <div class="row" style="padding: 10px !important;">
				<div class="row">
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Código</label>
					  <input class="form-control date_invoice" name="code" autofocus type="text" />
					</div>
					<div class="mb-3 col-md-5 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Producto</label>
					  <input class="form-control date_invoice" name="name" type="text" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">IVA</label>
					  <select class="form-select text-right" size="1" name="tax">
					  	<option value="0">0</option>
					  	<option value="5">5</option>
					  	<option value="19">19</option>
					  </select>
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Cantidad</label>
					  <input class="form-control date_invoice text-right" name="quantity" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Paca/Bulto/Paquete</label>
					  <input class="form-control date_invoice text-right" name="bale_quantity" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Unidad</label>
					  <input class="form-control date_invoice text-right" name="quantity_unit" type="number" />
					</div>
					
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Cantidad Static</label>
					  <input class="form-control date_invoice text-right" name="quantity_static" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Paca Static</label>
					  <input class="form-control date_invoice text-right" name="bale_quantity_static" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Unidad Static</label>
					  <input class="form-control date_invoice text-right" name="quantity_unit_static" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">IPO</label>
					  <input class="form-control date_invoice text-right" name="ipo" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Ultra Procesado</label>
					  <input class="form-control date_invoice text-right" name="ultra_processed" value="0" type="number" />
					</div>


					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Descuento</label>
					  <input class="form-control date_invoice text-right" name="discount" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Costo</label>
					  <input class="form-control date_invoice text-right" name="cost" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 1</label>
					  <input class="form-control date_invoice text-right" name="price_1" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 2</label>
					  <input class="form-control date_invoice text-right" name="price_2" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 3</label>
					  <input class="form-control date_invoice text-right" name="price_3" value="0" type="number" />
					</div>

					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 4</label>
					  <input class="form-control date_invoice text-right" name="price_4" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 5</label>
					  <input class="form-control date_invoice text-right" name="price_5" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 6</label>
					  <input class="form-control date_invoice text-right" name="price_6" value="0" type="number" />
					</div>

					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Categoria</label>
					  <select class="form-select cat" size="1" name="client">
					  	<option value="0" disabled selected>Seleccione Categoria...</option>
					  	{% for i in cat %}
					  		<option value="{{i.pk_category}}">{{i.name|title}}</option>
					  	{% endfor %}
					  </select>
					</div>
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Subcategoria</label>
					  <select class="form-select subc" size="1" disabled name="pk_subcategory"></select>
					</div>
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Proveedor</label>
					  <select class="form-select" size="1" name="pk_supplier">
					  	{% for i in supplier %}
					  		<option value="{{i.pk}}">{{i.name}}</option>
					  	{% endfor %}
					  </select>
					</div>
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Unidad de Medida</label>
					  <select class="form-select" size="1" name="unit_measures">
					  	{% for i in unit_measures %}
					  		<option value="{{i.id}}">{{i.name}}</option>
					  	{% endfor %}
					  </select>
					</div>
				</div>
				<div class="row p-1">
					<div class="col-3">
						<div class="mb-3">
							<input class="btn btn-primary save_product" type="button" value="Crear Producto">
						</div>
					</div>
					<div class="col-3">
						<div class="mb-3">
							<input class="btn btn-info create_category" type="button" value="Crear Categoria">
						</div>
					</div>
					<div class="col-3">
						<div class="mb-3">
							<input class="btn btn-success create_subcategory" type="button" value="Crear Subcategoria">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>


<button class="btn btn-primary category" type="button" hidden data-bs-toggle="modal" data-bs-target="#category">Launch demo modal</button>

<div class="modal fade" id="category" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog " role="document" style="max-width:800px">
    <div class="modal-content position-relative">
      <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
        <button class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
      	<div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
          <h4 class="mb-1" id="modalExampleDemoLabel">ESTA CATEGORIA SOLO SERÁ CREADA PARA ESTA SUCURSAL </h4>
        </div>
      	<div class="p-4 pb-0">
          <form>
            <div class="mb-3">
              <label class="col-form-label" for="recipient-name">Nombre de la categoria:</label>
              <input class="form-control name_category" type="text" />
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close_cat" type="button" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary create_cat" type="button">Crear Categoria </button>
      </div>
    </div>
  </div>
</div>

<button class="btn btn-primary subcat" type="button" hidden data-bs-toggle="modal" data-bs-target="#subcat">Launch demo modal</button>

<div class="modal fade" id="subcat" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog " role="document" style="max-width:800px">
    <div class="modal-content position-relative">
      <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
        <button class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
      	<div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
          <h4 class="mb-1" id="modalExampleDemoLabel">ESTA SUBCATEGORIA SOLO SERÁ CREADA PARA ESTA SUCURSAL </h4>
        </div>
      	<div class="p-4 pb-0">
          <form>
          	<div class="mb-3">
              <label class="col-form-label" for="recipient-name">Categorias:</label>
              <select class="form-select pk_list_cat" size="1" name="category">
						  	<option value="0" disabled selected>Seleccione Categoria...</option>
						  	{% for i in cat %}
						  		<option value="{{i.pk_category}}">{{i.name|title}}</option>
						  	{% endfor %}
					  	</select>
            </div>
            <div class="mb-3">
              <label class="col-form-label" for="recipient-name">Nombre de la subcategoria:</label>
              <input class="form-control name_subcategory" type="text" />
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close_subcat" type="button" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary create_subcat" type="button">Crear Subcategoria </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block script %}

	<script>
		preferens_columm  = 0
	  $(document).ready(function () {
	  	console.clear()

	  	$(".create_category").click(function(){
	  		$(".category").click()
	  	})

	  	$(".create_subcategory").click(function(){
	  		$(".subcat").click()
	  	})

	  	$(".create_subcat").click(function(){
	  		_name_subcat = $(".name_subcategory").val()
	  		_id = $(".pk_list_cat").val()
	  		$.ajax({
	  			url: "{% url 'Create_Subcategory_' %}",
	  			data: {"pk_category": _id,'name':_name_subcat},
	  			success: function(e){
	  				e = JSON.parse(e)
	  				if(e.result){
	  					noti_person("Tarea Finalizada", e.message)
	  					$(".name_subcategory").val('')
	  					$(".close_subcat").click()
	  				}
	  				else{
	  					noti_person("ERROR", e.message)
	  				}
	  			}
	  		})
	  	})

	  	$(".create_cat").click(function(){
	  		_name_cat = $(".name_category").val()
	  		$.ajax({
	  			url: "{% url 'Create_Category_' %}",
	  			data: {'name':_name_cat},
	  			success: function(e){
	  				e = JSON.parse(e)
	  				if(e.result){
	  					noti_person("Tarea Finalizada", e.message)
	  					$(".cat").append(`<option value="${e.category}">${_name_cat}</option>`)
	  					$(".name_category").val('')
	  					$(".close_cat").click()
	  				}
	  				else{
	  					noti_person("ERROR", e.message)
	  				}
	  			}
	  		})
	  	})


	    $(".cat").change(function () {
	      const id = $(this).val();
	      const subcSelect = $(".subc");
	      $.ajax({
	      	url:"{% url 'Get_Subcategory' %}",
	        data: { 'pk_category': id },
	        success: function (e) {
	          const obj = JSON.parse(e);
	          if(obj.length > 0){
		          subcSelect.empty();
		          subcSelect.append(`<option value="0" disabled selected>Seleccione Subcategoria...</option>`);
		          obj.forEach(function (item) {
		          	var name = item.name.charAt(0).toUpperCase() + item.name.slice(1).toLowerCase();
		            subcSelect.append(`<option value="${item.pk_sub}">${name}</option>`);
		          });
		          subcSelect.removeAttr("disabled");
		        }
		        else{
		        	subcSelect.empty()
		        	subcSelect.attr("disabled", "disabled");
		        	noti_person("ERROR", "Esta categoria no tiene valores agregados")
		        }
	        }
	      });
	    });

	    async function time_sleep() {
	      for (let i = 0; i < 2; i++) {
	        console.log(`Waiting ${i} seconds...`);
	        await sleep(i * 1000);
	      }
	      location.reload(true);
	    }

	    $(".subc").keyup(function (e) {
	      const code = e.keyCode ? e.keyCode : e.which;
	      if (code === 70) {
	        $(".save_product").click();
	      }
	    });

	    $(".save_product").click(function () {
	      const form = $('.form_save_product').serialize();
	      $.ajax({
	        data: form,
	        success: function (e) {
	          const obj = JSON.parse(e);
	          if (obj.result) {
	            noti_person("Tarea Finalizada", 'Producto creado con éxito')
	            time_sleep();
	          } else {
	            noti_person("ERROR", obj.message)
	          }
	        }
	      });
	    });

	    function sleep(ms) {
	      return new Promise(resolve => setTimeout(resolve, ms));
	    }


	    $(".list_product").click(function(){
	    	location.href = "{% url 'Get_List_Products' %}"
	    })
	  });
	</script>


{% endblock %}