{% extends '../base.html' %}
{% block content %}

<style>
  .table-responsive {
    max-height: 400px !important;
    overflow-y: auto !important;
  }
</style>

<div class="card mb-3" data-date="{{ i.registration_date }}">
  <div class="card-body p-2 overflow-hidden">
    <div class="row p-1">
      <div class="col-md-6 col-12">
        <h5>Realizar un traslado</h5>
      </div>
    </div>
  </div>
</div>


<div class="card mb-3">
  <div class="card-body">
    <div class="row">
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">N° de Traslado</label>
          <input class="form-control number_invoice text-right" disabled name="number_invoice" autofocus type="text" />
        </div>
        <div class="mb-3 col-md-3 col-12">
          <label class="form-label" for="exampleFormControlInput1">Fecha de Factura</label>
          <input class="form-control date_invoice" name="date_invoice" type="date" />
        </div>
        <div class="mb-3 col-md-4 col-12">
          <label class="form-label" for="exampleFormControlInput1">Sucursal</label>
          <select class="form-select branch_receives" size="1" name="client">
            <option value="0" disabled selected>Seleccione Sucursal...</option>
            {% for i in list_branch %}
              <option value="{{i.pk}}">{{i.name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3 col-md-3 col-12">
          <div class="form-check form-switch d-flex flex-column" style="display: flex !important; flex-direction: column !important;">
            <label class="form-check-label mb-2" for="flexSwitchCheckChecked">A todas las sucursales</label>
            <input class="form-check-input all_sucur" id="flexSwitchCheckChecked" type="checkbox" />
          </div>
        </div>
    </div>
  </div>
</div>
<div class="card mb-3">
  <div class="card-body">
    <div class="row" style="padding: 10px !important;">
      <div class="row">
        <div class="mb-3 col-md-4 col-12">
          <label class="form-label" for="exampleFormControlInput1">Producto</label>
          <input class="form-control product_name product" name="name_product" autofocus type="text"/>
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Cantidad</label>
          <input class="form-control quantity enter text-right" disabled name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Costo</label>
          <input class="form-control cost text-right enter" disabled name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-1 col-12">
          <label class="form-label" for="exampleFormControlInput1">IVA</label>
          <input class="form-control tax text-right enter" disabled disabled type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">ICO</label>
          <input class="form-control ipo text-right enter" disabled type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio por unidad</label>
          <input class="form-control text-right und enter" disabled id="1" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio 1</label>
          <input class="form-control text-right price1 number_price enter" disabled id="1" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio 2</label>
          <input class="form-control text-right price2 number_price enter" disabled id="2" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio 3</label>
          <input class="form-control text-right price3 number_price enter" disabled id="3" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio 4</label>
          <input class="form-control text-right price4 number_price enter" disabled id="1" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio 5</label>
          <input class="form-control text-right price5 number_price enter" disabled id="2" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Precio 6</label>
          <input class="form-control text-right price6 number_price enter" disabled id="3" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Ultra Procesado</label>
          <input class="form-control text-right ultra_processed enter" disabled id="3" name="date_invoice" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Descuento</label>
          <input class="form-control text-right discount number_price enter" name="discount" disabled id="5" type="number" />
        </div>
        <div class="mb-3 col-md-2 col-12">
          <label class="form-label" for="exampleFormControlInput1">Stock</label>
          <input class="form-control text-right stock" disabled type="number" />
        </div>
        <div class="row utilidad">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body p-2 overflow-hidden">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Descripción</th>
            <th>Cantidad</th>
            <th>Costo</th>
            <th>ICO</th>
            <th>IVA</th>
            <th>Descuento</th>
            <th>Precio 1</th>
            <th>Precio 2</th>
            <th>Precio 3</th>
            <th class="text-dark">Eliminar</th>
          </tr>
        </thead>
        <tbody class="row_product"></tbody>
      </table>
    </div>
  </div>
</div>
<div class="card mb-3">
  <div class="card-body p-2 overflow-hidden">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
              <textarea rows="5" style="resize: none;" class="form-control notes" placeholder="Observaciones"></textarea>
            </div>
            <div class="col-md-2"></div>
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-body p-2 overflow-hidden">
                        <div class="row">
                            <table class="table">
                                <tbody class="">
                                    <tr>
                                        <td class="text-right text-dark">
                                            SubTotal: 
                                        </td>
                                        <td class="text-right text-dark">
                                          <span class="subtotal" style="text-align: center !important;">0</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-right text-dark">
                                            Impuestos: 
                                        </td>
                                        <td class="text-right text-dark">
                                          <span class="impuestos" style="text-align: center !important;">$0</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-right text-dark">
                                            ICO: 
                                        </td>
                                        <td class="text-right text-dark">
                                          <span class="ico" style="text-align: center !important;">$0</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-right text-dark">
                                            Descuento: 
                                        </td>
                                        <td class="text-right text-dark">
                                          <span class="descuento" style="text-align: center !important;">$0</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-right text-dark">
                                            Total: 
                                        </td>
                                        <td class="text-right text-dark">
                                          <span class="total_invoice" style="text-align: center !important;">$0</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
<div class="card mb-3">
  <div class="card-body p-2 overflow-hidden">
    <div class="row justify-content-center">
      <button class="btn btn-primary col-sm-10 col-11 register_shopping" type="button">Enviar Pedido</button>
    </div>
  </div>
</div>







<button class="btn btn-primary modal_list_product" type="button" hidden data-bs-toggle="modal" data-bs-target="#modal_list_product">Launch demo modal</button>

<div class="modal fade" id="modal_list_product" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document" style="max-width:800px">
    <div class="modal-content position-relative">
      <div class="modal-body mb-3">
          <div class="">
          <table class="table" id="example" style="width:100%">
            <thead>
              <tr>
                <th class="text-dark w-100 text-center fs-0">Codigo</th>
                <th class="text-dark fs-0">Codigo</th>
                <th class="text-dark fs-0">Producto</th>
                <th class="text-dark">Cantidad</th>
                <th class="text-dark">Precio</th>
                <th class="text-dark">Descuento</th>
              </tr>
            </thead>
             <tbody>
              {% for i in product %}
                <tr tabindex="0">
                    <th scope="row">{{i.code}}</th>
                    <th>{{i.code}}</th>
                    <td>{{i.name}}</td>
                    <td>{{i.quantity}}</td>
                    <td>{{i.price_1}}</td>
                    <td>{{i.discount}}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer" hidden>
        <button class="btn btn-secondary close_list_product" type="button" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block script %}

  <script>
    var list_product = null;
    var obj = null;
    var products = [];
    var product = null
  </script>

  <script>
    $(document).ready(function() {

      $(document).on('keydown', function(event) {
        if (event.altKey && event.key.toLowerCase() === 'Escape') {
            $('.product_name').focus()
            $('.modal_list_product').modal('hide')
        } else if (event.altKey && event.key.toLowerCase() === 'p') {
            $(".product_name").val('')
            $("input[type='search']").val('')
            $('.modal_list_product').click()
            $("input[type='search']").trigger($.Event('keypress', { keyCode: 13 }))
        }
      });


      $(document).on('keydown',"input[type='search']",function(event){
        if($(this).val().length > 0){
          const table = document.querySelector("#example tbody");
          const rows = table.querySelectorAll("tr");
          let focusedRowIndex = 0;
          if (event.key === "ArrowDown") {
                focusedRowIndex = Math.min(focusedRowIndex + 1, rows.length - 1);
                rows[focusedRowIndex].focus();
                event.preventDefault();
            }
          }
      })
      


      $('#modal_list_product').on('shown.bs.modal', function () {
        $("input[type='search']").focus();
        const table = document.querySelector("#example tbody");
        const rows = table.querySelectorAll("tr");
        let focusedRowIndex = 0;

        $(table).keydown(function(event) {
          if (event.key === "ArrowDown") {
              focusedRowIndex = Math.min(focusedRowIndex + 1, rows.length - 1);
              rows[focusedRowIndex].focus();
              event.preventDefault();
          } else if (event.key === "ArrowUp") {
              focusedRowIndex = Math.max(focusedRowIndex - 1, 0);
              rows[focusedRowIndex].focus();
              event.preventDefault();
          } else if (event.key === "Enter") {
            const firstCell = rows[focusedRowIndex].querySelector("th, td");
            $.ajax({
              url: "{% url 'Loading_Product' %}",
              data: {'code': firstCell.textContent},
              success: function (e) {
                _e = JSON.parse(e);
                products.push(_e)
                obj = JSON.parse(e);
                console.log(obj)
                $(".product_name").val(obj['name'])
                $(".cost").val(obj['cost'])
                $(".tax").val(obj['tax'])
                $(".ipo").val(obj['ipo'])
                $(".price1").val(obj['price_1'])
                $(".price2").val(obj['price_2'])
                $(".price3").val(obj['price_3'])
                $(".price4").val(obj['price_4'])
                $(".price5").val(obj['price_5'])
                $(".price6").val(obj['price_6'])
                $(".und").val(obj['total_cost'])
                $(".discount").val(0)
                $('.quantity').prop("disabled", false)
                $(".quantity").focus()
                $('.cost').prop("disabled", false)
                $(".ipo").prop("disabled", false)
                $(".price1").prop("disabled", false)
                $(".price2").prop("disabled", false)
                $(".price3").prop("disabled", false)
                $(".price4").prop("disabled", false)
                $(".price5").prop("disabled", false)
                $(".price6").prop("disabled", false)
                $(".und").prop("disabled", false)
                $(".stock").val(obj['quantity'])
                $(".quantity").val('')
                $(".close_list_product").click();
                $(".quantity").focus()
                $("input[type='search']").val('')
              }
            });
          }
        })
        $("input[type='search']").keydown(function(event) {
          if (event.key === "ArrowDown") {
            rows[0].focus()
          }
        })
      });
    });
  </script>

  <script>
    preferens_columm  = 0
    $(document).ready(function(){
      
      function Get_Number(){
        $.ajax({
          url: "{% url 'Get_Number' %}",
          data:{'type_document':98},
          success:function(e){
            _e = JSON.parse(e)
            $(".number_invoice").val(_e._from)
          }
        })
      }

      setInterval(function() {
        Get_Number()
      }, 1000);

      $(".date_invoice").val(new Date().toISOString().split('T')[0])

      $(".product").keypress(function(e){
        const value = parseInt($(this).val());
        const code = e.keyCode ? e.keyCode : e.which;
        if(code == 13){
          if($(this).val().length == 0){
            $('.modal_list_product').click();
          }
        }
      });

      $(document).on('keyup','.enter', function(e) {
        if($(this).val().length > 0){
          const code = e.keyCode ? e.keyCode : e.which;
          value_quantity = $('.quantity').val()
          if(code == 13){
            if(value_quantity !== ""){
              product = products.filter(producto => producto.code === $(".list_product").val())
              if(product.length > 0){
                console.log(value_quantity)
                UpdateExistingProduct(product[0],value_quantity)
              }
              else{
                Add_Product_Table(value_quantity)
              }
              $(".quantity").val("")
              $(".list_product").focus()
            }
            else{
              $.notify("No puede agregar valores si la cantidad esta vacia",'error')
              $('.quantity').focus()
            }
          }
        }
      })
      $(".product").keyup(function (e) {
        const value = parseInt($(this).val());
        const code = e.keyCode ? e.keyCode : e.which;
        if(code == 13){
          if($(this).val().length > 0){
            id = $(this).val();
            $.ajax({
              url: "{% url 'Loading_Product' %}",
              data: {'code': id},
              success: function (e) {
                obj = JSON.parse(e);
                $(".cost").val(obj['cost'])
                $(".tax").val(obj['tax'])
                $(".ipo").val(obj['ipo'])
                $(".price1").val(obj['price_1'])
                $(".price2").val(obj['price_2'])
                $(".price3").val(obj['price_3'])
                $(".discount").val(0)
                $('.quantity').prop("disabled", false)
                $(".quantity").focus()
                $('.cost').prop("disabled", false)
                $(".ipo").prop("disabled", false)
                $(".price1").prop("disabled", false)
                $(".price2").prop("disabled", false)
                $(".price3").prop("disabled", false)
                $(".price4").prop("disabled", false)
                $(".stock").val(obj['quantity'])
              }
            });
          }
          else{
            $('#price').empty()
            $(".stock").val(0)
          }
        }
      });

      function Headers(){
        return JSON.stringify({
          "number":$(".number_invoice").val(),
          "date_registration":$(".date_invoice").val(),
          "branch_receives":$(".branch_receives").val(),
          "notes":$(".notes").val()
        }, null, 2)
      }


      $(".register_shopping").click(function(){
        items = JSON.stringify(products, null, 2)
        headers = Headers()
        if($(".branch_receives").val() != 0){
          $.ajax({
            url:"{% url 'Save_Transfer' %}",
            method: "POST",
            data:{csrfmiddlewaretoken: '{{ csrf_token }}','items':items, 'headers':headers},
            success: function(e){
              e = JSON.parse(e)
              console.log(e)
              if(!e.result){
                noti_person('ERROR', e.message)
              }
              else{
               noti_person('Tarea Finalizada', "Factura de compra registrada con éxito")
               location.reload(true) 
              }
            }
          })
        }else{
          noti_person('ALERTA', "Debe seleccionar una sucursal.")
        }
      })

      $(document).on('keyup',".number_price",function(){
        id = this.id
        value_price = parseInt($(this).val())
        value_cost = parseInt($(".cost").val())
        if(value_price > value_cost){
          price =((( value_price - value_cost ) / value_price) * 100).toFixed(1)
          $(".percentage"+id).val(price+'%')
        }
        else{
          $(".percentage"+id).val('0%') 
        }
      })

      $(document).on('keyup',".cost",function(){
        var index = 1;
        for(index; index <= 4; index++){
          id = index
          price = 0
          value_price = parseInt($(".price"+index).val())
          value_cost = parseInt($(this).val())
          if(value_price > value_cost){
            price =((( value_price - value_cost ) / value_price) * 100).toFixed(1)
            $(".percentage"+id).val(price+'%')
          }
          else{
            $(".percentage"+id).val('0%') 
          }
        }
        index = 1;
      })


      function UpdateExistingProduct(product, newQuantity) {
        const existingRow = $(`.row_product td.${product.code}`).closest("tr");
        if (existingRow.length > 0) {
          const quantityCell = existingRow.find(".text-center");
          total_quantity = newQuantity !== "" ? parseInt(newQuantity) + parseInt(quantityCell.text()) : quantityCell
          quantityCell.text(total_quantity);
          product.quantity = total_quantity

          const costCell = existingRow.find(`.cost${product.code}`);
          const ipoCell = existingRow.find(`.ipo${product.code}`);
          const priceCell = existingRow.find(`.price${product.code}`);
          const price2Cell = existingRow.find(`.price2${product.code}`);
          const price3Cell = existingRow.find(`.price3${product.code}`);
          const price4Cell = existingRow.find(`.discount${product.code}`);

          costCell.text($('.cost').val())
          ipoCell.text($(".ipo").val())
          priceCell.text($(".price1").val())
          price2Cell.text($(".price2").val())
          price3Cell.text($(".price3").val())
          price4Cell.text($(".discount").val())

          product.cost = $('.cost').val()
          product.ipo = $(".ipo").val()
          product.price = $(".price1").val()
          product.price2 = $(".price2").val()
          product.price3 = $(".price3").val()
          product.price4 = $(".discount").val()
          CalculateTotalsInvoice()
        }
      }

      function Clean(){
        $(".product").val('')
        $(".product").focus()
        $('.cost').val('0')
        $(".ipo").val('0')
        $(".price1").val('0')
        $(".price2").val('0')
        $(".price3").val('0')
        $(".price4").val('0')
        $(".price5").val('0')
        $(".discount").val('0')
        $(".stock").val('0')
        $(".und").val('0')
        $('.quantity').prop("disabled", true)
        $(".quantity").focus()
        $('.cost').prop("disabled", true)
        $(".ipo").prop("disabled", true)
        $(".price1").prop("disabled", true)
        $(".price2").prop("disabled", true)
        $(".price3").prop("disabled", true)
        $(".price4").prop("disabled", true)
        $(".und").prop("disabled", true)
        $(".price5").prop("disabled", true)
        $(".price6").prop("disabled", true)
      }

      $(document).on('click',".delete",function(){
        id = this.id
        console.log(id)
        console.log(products)
        $(this).closest('tr').remove();
        const indexToRemove = products.findIndex(product => product.code === id);
        if (indexToRemove >= 0) {
          products.splice(indexToRemove, 1);
        }
        CalculateTotalsInvoice()
        console.log(products)
        Clean()

      })


      function Add_Product_Table(newQuantity){
        $(".row_product").append(`
          <tr>
            <td class="${obj['code']}">${obj['name']}</td>
            <td class="text-center">${newQuantity}</td>
            <td class"cost${obj['code']}"> ${$('.cost').val()}</td>
            <td class"ipo${obj['code']}">${$('.ipo').val()}</td>
            <td>${obj['tax']}</td>
            <td class"price4${obj['code']}">${$('.discount').val()}</td>
            <td class"price${obj['code']}">${$('.price1').val()}</td>
            <td class"price2${obj['code']}">${$('.price2').val()}</td>
            <td class"price3${obj['code']}">${$('.price3').val()}</td>
            <td class"text-center"><span class="fas fa-trash-alt delete delete_product_row${obj['code']}" id="${obj['code']}"></span></td>
          </tr>
        `)

        products.push({
          'code': obj['code'],
          'name': obj['name'],
          'cost': $('.cost').val(),
          'ipo': $(".ipo").val(),
          'price_1': $(".price1").val(),
          'price_2': $(".price2").val(),
          'price_3': $(".price3").val(),
          'discount': $(".discount").val(),
          'quantity': $(".quantity").val(),
          'tax': obj['tax']
        })
        CalculateTotalsInvoice()
        return 0
      }

    })

    function CalculateTotalsInvoice(){
        var filas = $(".row_product").find("tr");
        var resultado = "";
        let subtotal_row_table_invoice = 0
        let impoconsumo = 0
        let impuestos = 0
        let tax_row_table_invoice = 0
        for(i=0; i<filas.length; i++){
            var celdas = $(filas[i]).find("td")
            _quantity = parseFloat($(celdas[1]).text())
            tax = (1 + (parseFloat($(celdas[4]).text() / 100)))
            subtotal_row_table_invoice += (parseFloat($(celdas[2]).text()) / tax) * _quantity
            impoconsumo += parseFloat($(celdas[3]).text()) * _quantity
            impuestos += (parseFloat($(celdas[2]).text()) - (parseFloat($(celdas[2]).text()) / tax)) * _quantity
        }
        $(".subtotal").text(Math.round(subtotal_row_table_invoice))
        $(".ico").text(Math.round(impoconsumo))
        $('.impuestos').text(Math.round(impuestos))
        $('.descuento').val(0)
        let total = impoconsumo + subtotal_row_table_invoice + impuestos
        $(".total_invoice").text(Math.round(total))
        $(".quantity").val('')
        $(".total_product").val(total);
    }
    
  </script>

{% endblock %}