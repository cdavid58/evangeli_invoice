{% extends '../base.html' %}
{% block content %}

<div class="card mb-3 p-1" data-date="{{ i.registration_date }}">
  <div class="card-body p-2 overflow-hidden">
    <div class="row">
      <div class="col-6">
        <h5>Editar producto " {{p.name}} "</h5>
      </div>
      <div class="col-3 ml-auto">
        <button class="btn btn-info list_product">
        	<span class="nav-link-icon">
        		<span class="fas fa-chevron-left"></span>
        	</span>
        	<span class="nav-link-text ps-1">Lista de productos</span>
        </button>
      </div>
    </div>
  </div>
</div>

<form class="form_edit_product">
	<div class="card mb-3">
		<div class="card-body">
		  <div class="row" style="padding: 10px !important;">
				<div class="row">
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Código</label>
					  <input class="form-control date_invoice" value="{{p.code}}" name="code" type="text" />
					</div>
					<div class="mb-3 col-md-5 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Producto</label>
					  <input class="form-control date_invoice" name="name" value="{{p.name}}" type="text" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">IVA</label>
					  <select class="form-select text-right _tax" size="1" name="tax">
					  	<option value="{{p.tax}}">{{p.tax}}</option>
					  	{% for i in tax %}
					  		{% if i != p.tax %}
						  		<option value="{{i}}">{{i}}</option>
					  		{% endif %}
						  {% endfor %}
					  </select>
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Cantidad</label>
					  <input class="form-control date_invoice text-right" value="{{p.quantity}}"  name="quantity" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Paca/Bulto/Paquete</label>
					  <input class="form-control date_invoice text-right" value="{{p.bale_quantity}}"  name="bale_quantity" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Unidad</label>
					  <input class="form-control date_invoice text-right" value="{{p.quantity_unit}}" name="quantity_unit" type="number" />
					</div>
					
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Cantidad Static</label>
					  <input class="form-control date_invoice text-right" value="{{p.quantity_unit}}" name="quantity_static" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Paca Static</label>
					  <input class="form-control date_invoice text-right" value="{{p.quantity_unit}}" name="bale_quantity_static" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Unidad Static</label>
					  <input class="form-control date_invoice text-right" value="{{p.quantity_unit}}" name="quantity_unit_static" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">IPO</label>
					  <input class="form-control date_invoice text-right" value="{{p.ipo}}" name="ipo" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Ultra Procesado</label>
					  <input class="form-control date_invoice text-right" value="{{p.ultra_processed}}" name="ultra_processed" value="0" type="number" />
					</div>


					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Descuento</label>
					  <input class="form-control date_invoice text-right" value="{{p.discount}}" name="discount" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Costo</label>
					  <input class="form-control date_invoice text-right price" value="{{p.cost}}" name="cost" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 1</label>
					  <input class="form-control date_invoice text-right price" id="1"  value="{{p.price_1}}" name="price_1" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 2</label>
					  <input class="form-control date_invoice text-right price" id="2"  value="{{p.price_2}}" name="price_2" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 3</label>
					  <input class="form-control date_invoice text-right price" id="3"  value="{{p.price_3}}" name="price_3" value="0" type="number" />
					</div>

					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 4</label>
					  <input class="form-control date_invoice text-right price" id="4"  value="{{p.price_4}}" name="price_4" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 5</label>
					  <input class="form-control date_invoice text-right price" id="5"  value="{{p.price_5}}" name="price_5" value="0" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">Precio 6</label>
					  <input class="form-control date_invoice text-right price" id="6"  value="{{p.price_6}}" name="price_6" value="0" type="number" />
					</div>

					<div class="mb-3 col-md-2 col-6">
					  <label class="form-label" for="exampleFormControlInput1">% de Incremento</label>
					  <input class="form-control date_invoice text-right" name="percentages" value="{{p.percentages}}" value="0" type="number" />
					</div>

					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Categoria</label>
					  <select class="form-select cat" size="1" name="client">
					  	<option value="{{p.pk_category}}">{{p.name_category|title}}</option>
					  	{% for i in cat %}
					  		{% if i.pk_category != p.pk_category %}
					  			<option value="{{i.pk_category}}">{{i.name|title}}</option>
					  		{% endif %}
					  	{% endfor %}
					  </select>
					</div>
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Subcategoria</label>
					  <select class="form-select subc" size="1" name="pk_subcategory">
					  	<option value="{{p.pk_subcategory}}">{{p.subcategory|title}}</option>
					  	{% for i in p.list_subcategory %}
					  		{% if i.pk_sub != p.pk_subcategory %}
					  			<option value="{{i.pk_sub}}">{{i.name|title}}</option>
					  		{% endif %}
					  	{% endfor %}
					  </select>

					</div>
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Proveedor</label>
					  <select class="form-select" size="1" name="pk_supplier">
					  	{% for i in supplier %}
					  		<option value="{{i.pk}}">{{i.name}}</option>
					  	{% endfor %}
					  </select>
					</div>
					<div class="mb-3 col-md-3 col-12">
					  <label class="form-label" style="text-align: center;" for="exampleFormControlInput1">Unidad de Medida</label>
					  <select class="form-select" size="1" name="unit_measures">
					  	<option value="{{p.unit_measures}}">{{p.unit_measures_name}}</option>
					  	{% for i in unit_measures %}
					  		{% if i.id != p.unit_measures %}
					  			<option value="{{i.id}}">{{i.name}}</option>
					  		{% endif %}
					  	{% endfor %}
					  </select>
					</div>
					<div class="row">
						<h5 class="mb-3">Margen de utilidad</h5>
						{% for i in p.calculate_profit_percentages %}
							<div class="mb-3 col-md-2 col-6">
							  <label class="form-label" for="exampleFormControlInput1">{{i.name}}</label>
							  <input class="form-control date_invoice text-right percentage{{i.id}}" disabled value="{{i.percentage}}" type="text" />
							</div>
						{% endfor %}
					</div>
				</div>
				<div class="row p-1">
					<div class="mb-3">
						<input class="btn btn-primary edit_product" type="button" value="Actualizar Producto">
					</div>
				</div>
				</div>
			</div>
		</div>
	</div>
</form>


{% endblock %}
{% block script %}

	<script>
		preferens_columm  = 0
	  $(document).ready(function () {
	  	// console.clear()
	    $(".cat").change(function () {
	      const id = $(this).val();
	      $.ajax({
	        url: "{% url 'Get_Subcategory' %}",
	        data: { 'pk_category': id },
	        success: function (e) {
	          const obj = JSON.parse(e);
	          const subcSelect = $(".subc");
	          subcSelect.empty();
	          obj.forEach(function (item) {
	            subcSelect.append(`<option value="${item.pk_sub}">${item.name}</option>`);
	          });
	          subcSelect.removeAttr("disabled");
	        }
	      });
	    });

	    $(".subc").keyup(function (e) {
	      const code = e.keyCode ? e.keyCode : e.which;
	      if (code === 70) {
	        $(".save_product").click();
	      }
	    });

	    $(".edit_product").click(function () {
	      const form = $('.form_edit_product').serialize();
	      console.log(form)
	      $.ajax({
	        data: form,
	        success: function (e) {
	          e = JSON.parse(e)
	          if (e.result) {
	            noti_person("Tarea Finalizada", 'Producto actualizado con éxito')
	          } 
	          else {
	          	noti_person("ERROR", e.message)
	          }
	        }
	      });
	    });

	    $(".list_product").click(function(){
	    	location.href = "{% url 'Get_List_Products' %}"
	    })

	    $(document).on('keyup',".price",function(){
	    	id = this.id
	    	value_tax = parseInt($("._tax").val())
	    	value_price = Math.round(parseInt($(this).val()) / (1 + (value_tax / 100)),1)
	    	value_cost = Math.round(parseFloat($(".cost").val()),1)
	    	console.log(value_price)
	    	console.log(value_cost)
	    	if(value_price >= value_cost){
	    		console.log("success")
		    	price = ((( value_price - value_cost ) / value_price) * 100).toFixed(1)
		    	$(".percentage"+id).val(price+'%')
		    }
		    else{
		    	console.log("ERROR")
		    	$(".percentage"+id).val('0%')	
		    }
	    })


	  });
	</script>


{% endblock %}