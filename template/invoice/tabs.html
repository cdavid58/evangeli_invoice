
<style>
    @keyframes blink {
        0% {opacity: 1;}
        50% {opacity: 0;}
        100% {opacity: 1;}
    }

    .blink {
        animation: blink 1s infinite;
    }

		.modal-backdrop {
	    z-index: 1040 !important; /* Verifica que no haya conflicto con el z-index */
	    display: none !important; /* Asegúrate de que no haya un 'display: block' que interfiera */
		}
</style>


<div class="card mb-3 p-1" data-date="{{ i.registration_date }}">
  <div class="card-body p-2 overflow-hidden">
    <div class="row">
      <div class="col-md-3 col-12">
        <h5>Facturación</h5>
      </div>
      <div class="col-md-6 col-12 ml-auto text-right">
      	<div class="row">
	      	<div class="col-md-9 col-12">
	        	<h5><span class="sms_resolution text-right text-danger"></span></h5>
	      	</div>
	      	<div class="col-md-3 col-12">
	        	<h5>N° <span class="number_invoice text-right"></span></h5>
	      	</div>
	      </div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
	<div class="card-body">
	  <div class="row">
			<div class="row">
				{% if 'Facturacion' in permission %}
					{% if unit %}
						<div class="mb-3 col-md-2 col-12">
						  <label class="form-label" for="exampleFormControlInput1">Precio 1</label>
						  <input class="form-control price_1_{{tab_id}}" disabled name="price_1" type="number" />
						</div>
					{% endif %}
					{% if bale %}
						<div class="mb-3 col-md-2 col-12">
						  <label class="form-label" for="exampleFormControlInput1">Precio 2</label>
						  <input class="form-control price_2_{{tab_id}}" disabled name="price_2" type="number" />
						</div>
					{% endif %}
					{% if quantity %}
						<div class="mb-3 col-md-2 col-12">
						  <label class="form-label" for="exampleFormControlInput1">Precio 3</label>
						  <input class="form-control price_3_{{tab_id}}" disabled name="price_3" type="number" />
						</div>
					{% endif %}
					{% if unit %}
						<div class="mb-3 col-md-2 col-12">
						  <label class="form-label" for="exampleFormControlInput1">Precio 4</label>
						  <input class="form-control price_4_{{tab_id}}" disabled name="price_4" type="number" />
						</div>
					{% endif %}
					{% if bale %}
						<div class="mb-3 col-md-2 col-12">
						  <label class="form-label" for="exampleFormControlInput1">Precio 5</label>
						  <input class="form-control price_5_{{tab_id}}" disabled name="price_5" type="number" />
						</div>
					{% endif %}
					{% if quantity %}
						<div class="mb-3 col-md-2 col-12">
						  <label class="form-label" for="exampleFormControlInput1">Precio 6</label>
						  <input class="form-control price_6_{{tab_id}}" disabled name="price_6" type="number" />
						</div>
					{% endif %}
				{% else %}
					<div class="mb-3 col-md-2 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Precio 1</label>
					  <input class="form-control price_1_{{tab_id}}" disabled name="price_1" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Precio 2</label>
					  <input class="form-control price_2_{{tab_id}}" disabled name="price_2" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Precio 3</label>
					  <input class="form-control price_3_{{tab_id}}" disabled name="price_3" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Precio 4</label>
					  <input class="form-control price_4_{{tab_id}}" disabled name="price_4" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Precio 5</label>
					  <input class="form-control price_5_{{tab_id}}" disabled name="price_5" type="number" />
					</div>
					<div class="mb-3 col-md-2 col-12">
					  <label class="form-label" for="exampleFormControlInput1">Precio 6</label>
					  <input class="form-control price_6_{{tab_id}}" disabled name="price_6" type="number" />
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>


<div class="card mb-3">
	<div class="card-body">
	  <div class="row" style="padding: 10px !important;">
			<div class="row">
				<div class="mb-3 col-md-3  col-12">
					<label for="organizerMultiple">Cliente</label>
					<select class="form-select js-choice client_{{tab_id}} text-dark" id="client" size="1">
					  {% for i in client %}
					  	<option value="{{i.pk_customer}}">{{i.name}}</option>
					  {% endfor %}
					</select>
				</div>
				<div class="mb-3 col-md-2 col-12">
				  <label class="form-label" for="exampleFormControlInput1">Fecha</label>
				  <input class="form-control date_invoice_{{tab_id}}" name="date_invoice" type="date" />
				</div>
				<div class="mb-3 col-md-2 col-12 due_date_{{tab_id}}" style="display: none;">
				  <label class="form-label" for="exampleFormControlInput1">Fecha de vencimiento</label>
				  <input class="form-control date_invoice_due_{{tab_id}}" name="date_invoice" type="date" />
				</div>
				<div class="mb-3 col-md-3  col-12">
					<label for="organizerMultiple">Forma de Pago</label>
					<select class="form-select js-choice paymentform_{{tab_id}} control" id="paymentform" size="1" name="paymentform" data-target="{{tab_id}}">
					  <option value="1">Efectivo</option>
					  <option value="2">Crédito</option>
					  <option value="3">Transferencia</option>
					</select>
				</div>
			</div>

			<div class="row">
				<div class="mb-3 col-md-3  col-12">
					<label for="organizerMultiple">Referencia</label>
					<input class="form-control referens_{{tab_id}}" name="waiter" type="text" />
				</div>
				<div class="mb-3 col-md-3 col-12">
				  <label class="form-label" for="exampleFormControlInput1">Asignar Cuenta</label>
				  <input class="form-control save_account_{{tab_id}}" type="button" value="Guardar Cuenta" />
				</div>
				<div class="mb-3 col-md-3 col-12">
				  <label class="form-label" for="exampleFormControlInput1">Recuperar Cuentas</label>
				  <input class="form-control recovery_invoice_{{tab_id}}" type="button" value="Recuperar Cuenta" />
				</div>
				<div class="mb-3 col-md-2  col-12">
					<label for="organizerMultiple">Cuentas Congeladas</label>
					<input class="form-control text-right account_p_{{tab_id}}" name="waiter" type="number" disabled />
				</div>
			</div>
		</div>
	</div>
</div>

<div class="card mb-3">
	<div class="card-body">
	  <div class="row">
			<div class="row">
				<div class="mb-3 col-md-4  col-12">
					<label for="organizerMultiple">Cliente</label>
					<select class="form-select js-choice product_name_{{tab_id}} text-dark" id="client" size="1">
						<option value="0">Elije un producto</option>
					  {% for i in product %}
					  	<option value="{{i.code}}">{{i.name}}</option>
					  {% endfor %}
					</select>
				</div>
				<div class="mb-3 col-md-1 col-4">
				  <label class="form-label" for="exampleFormControlInput1" class="text-dark">Precio</label>
				  <input class="form-control price price_{{tab_id}} text-right" name="price" value="1" type="number" />
				</div>
				<div class="mb-3 col-md-2 col-4">
				  <label class="form-label" for="exampleFormControlInput1" class="text-dark">Cantidad</label>
				  <input class="form-control quantity_{{tab_id}} text-right" name="quantity" type="number" />
				</div>
				<div class="mb-3 col-md-1 col-3">
				  <label class="form-label" for="exampleFormControlInput1" class="text-dark">Stock</label>
				  <input class="form-control stock_{{tab_id}} text-right" disabled name="stock" type="number" value="0" />
				</div>
				<div class="mb-3 col-md-2 col-4">
				  <label class="form-label" for="exampleFormControlInput1" class="text-dark">Total</label>
				  <input class="form-control total_product_{{tab_id}} text-right" disabled name="total_product" value="0" type="number" />
				</div>
				<div class="mb-3 col-md-2 col-12">
          <div class="form-check form-switch">
            <label class="form-check-label mb-2" for="flexSwitchCheckChecked">CONSUMO INTERNO</label><br>
            <input class="form-check-input ci_{{tab_id}}" id="flexSwitchCheckChecked" type="checkbox" />
          </div>
        </div>
			</div>
		</div>
	</div>
</div>

<div class="card mb-3">
  <div class="card-body p-2 overflow-hidden">
  	<div class="table-responsive">
	    <table class="table">
	      <thead>
	        <tr>
	          <th class="fs-0 text-dark">Código</th>
	          <th class="text-dark">Descripción</th>
	          <th class="text-dark">Cantidad</th>
	          <th class="text-dark">T.Precio</th>
	          <th class="text-dark">V. Consu</th>
	          <th class="text-dark">Base</th>
	          <th class="text-dark">IVA</th>
	          <th class="text-dark">Descuento</th>
	          <th class="text-dark">ICO</th>
	          <th class="text-dark">SubTotal</th>
	          <th class="text-dark">Neto</th>
	          <th class="text-dark">Eliminar</th>
	        </tr>
	      </thead>
	      <tbody class="row_product_{{tab_id}}"></tbody>
	    </table>
	  </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body p-2 overflow-hidden">
  	<div class="container">
		    <div class="row">
		        <div class="col-md-6">
		        	<textarea rows="5" style="resize: none;" class="form-control notes_{{tab_id}}" placeholder="Observaciones"></textarea>
		        </div>
		        <div class="col-md-2"></div>
		        <div class="col-md-4">
		            <div class="card mb-3">
		                <div class="card-body p-2 overflow-hidden">
		                    <div class="row">
		                        <table class="table">
		                            <tbody class="">
		                                <tr>
		                                    <td class="text-right text-dark">
		                                        SubTotal: 
		                                    </td>
		                                    <td class="text-right text-dark">
		                                    	<span class="subtotal_{{tab_id}}" style="text-align: center !important;">0</span>
		                                    </td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right text-dark">
		                                        Impuestos: 
		                                    </td>
		                                    <td class="text-right text-dark">
		                                    	<span class="impuestos_{{tab_id}}" style="text-align: center !important;">$0</span>
		                                    </td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right text-dark">
		                                        ICO: 
		                                    </td>
		                                    <td class="text-right text-dark">
		                                    	<span class="ico_{{tab_id}}" style="text-align: center !important;">$0</span>
		                                    </td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right text-dark">
		                                        Descuento: 
		                                    </td>
		                                    <td class="text-right text-dark">
		                                    	<span class="descuento_{{tab_id}}" style="text-align: center !important;">$0</span>
		                                    </td>
		                                </tr>
		                                <tr>
		                                    <td class="text-right text-dark">
		                                        Total: 
		                                    </td>
		                                    <td class="text-right text-dark">
		                                    	<span class="total_invoice_{{tab_id}}" style="text-align: center !important;">$0</span>
		                                    </td>
		                                </tr>
		                            </tbody>
		                        </table>
		                    </div>
		                </div>
		            </div>
		        </div>
		    </div>
		</div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body p-2 overflow-hidden">
  	<div class="container">
	    <div class="row">
	    	<button class="btn btn-primary save_invoice_billing_{{tab_id}} col-5" title="Se factura segun la ley">Facturar</button>
	    </div>
	  </div>
	</div>
</div>


<button class="btn btn-primary question_excel_inventory_{{tab_id}}" type="button" data-bs-toggle="modal" hidden data-bs-target="#invent_excel_{{tab_id}}">Launch demo modal</button>

<div class="modal fade" id="invent_excel_{{tab_id}}" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="max-width:800px">
    <div class="modal-content position-relative">
      <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
        <button class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="row">
          <div class="col-12">
            <table class="table items_saved_{{tab_id}}">
              <thead>
                <tr>
                  <th>Referencia</th>
                  <th>Fecha</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody class="row_product_local_{{tab_id}}"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary close_invoice_save" type="button" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<button class="btn btn-primary question_money_client_{{tab_id}}" type="button" hidden data-bs-toggle="modal" data-bs-target="#question_money_client_{{tab_id}}">Launch static backdrop modal</button>


<div class="modal fade" id="question_money_client_{{tab_id}}" data-bs-keyboard="false" data-bs-backdrop="static" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg mt-6" role="document">
    <div class="modal-content border-0">
      <div class="position-absolute top-0 end-0 mt-3 me-3 z-index-1">
        <button class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="bg-light rounded-top-lg py-3 ps-4 pe-6">
          <h4 class="mb-1" id="staticBackdropLabel">Finalizar compra</h4>
        </div>
        <div class="p-4">
          <div class="row">
            <div class="mb-3 col-md-5">
              <label class="col-form-label" for="recipient-name">¿Con cuánto cancela el cliente?</label>
              <input class="form-control money_client{{tab_id}}" id="recipient-name" type="number" />
            </div>
            <div class="mb-3 col-md-4">
              <label class="col-form-label" for="message-text">Valor a devolver:</label>
              <input class="form-control return_money_client{{tab_id}}" value="0" id="recipient-name" type="number" />
            </div>
            <div class="mb-3 col-md-3">
              <div class="form-check form-switch d-flex flex-column" style="display: flex !important; flex-direction: column !important;">
                <label class="form-check-label mb-2" for="flexSwitchCheckChecked">¿Impuesto al consumo?</label>
                <input class="form-check-input impoc{{tab_id}}" id="flexSwitchCheckChecked" type="checkbox" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<button class="btn btn-primary loader_{{tab_id}}" hidden type="button" data-bs-toggle="modal" data-bs-target="#loader1_{{tab_id}}">Launch static backdrop modal</button>



<div class="modal fade" id="loader1_{{tab_id}}" data-bs-keyboard="false" data-bs-backdrop="static" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg mt-6 modal-dialog-centered" role="document">
    <div class="modal-content border-0">
      <div class="modal-body p-0 d-flex flex-column justify-content-center align-items-center" style="min-height: 300px;">
        <!-- Spinner -->
        <div class="spinner"></div>
        <!-- Texto debajo del spinner -->
        <p class="mt-3 text-dark">Enviando factura a la DIAN</p>
      </div>
    </div>
  </div>
</div>

<style>
  /* Spinner centrado */
  .spinner {
    width: 80px;
    height: 80px;
    border: 8px solid rgba(0, 0, 0, 0.1); /* Bordes suaves */
    border-top-color: #3498db; /* Color principal del borde superior */
    border-radius: 50%; /* Hace que el div sea circular */
    animation: spin 1s linear infinite; /* Animación de giro infinita */
    overflow: hidden;
  }

  /* Animación de giro */
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Estilos adicionales */
  .modal-body p {
    font-size: 18px;
    color: #333;
    overflow: hidden;
  }
</style>




<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
	
	let products_{{tab_id|safe}} = [];
  let limit_stock_{{tab_id|safe}} = 10
  let local_items_saved_{{tab_id|safe}} = false
  let local_row_items_saved_{{tab_id|safe}} = false
  let referens_header_{{tab_id|safe}} = null
  let referens_body_{{tab_id|safe}} = null
  var header_{{tab_id|safe}} = new Object();
  let id_product_{{tab_id|safe}} = null;
  let active_account_{{tab_id|safe}} = false
  let prefix_{{tab_id|safe}} = null
  let res_type_document_{{tab_id|safe}} = 1
  let t_d_{{tab_id|safe}} = false
  let omitir_{{tab_id|safe}} = false
  let topemax_{{tab_id|safe}} = 235325
  let imnpoc_{{tab_id|safe}} = false
  let percentages_{{tab_id|safe}} = null
  let percentagesactive_{{tab_id|safe}} = false
  let value_increase{{tab_id|safe}} = 0


	function format(data) {
    return `
      <div>Código: ${data[1]}</div>
      <div>Articulo: ${data[2]}</div>
      <div>Cantidad: ${data[3]}</div>
    `
  }

  preferens_columm = 0
  name_pdf = "Reporte de productos"
  name_excel = "Reporte de productos"
  title_pdf = "Reporte de productos"
  title_excel = "Reporte de productos"

	$(document).ready(function() {


		var myModal = document.getElementById('question_money_client_{{tab_id}}');

		myModal.addEventListener('hidden.bs.modal', function () {
		    var backdrops = document.getElementsByClassName('modal-backdrop');
		    if (backdrops.length > 0) {
		        for (var i = 0; i < backdrops.length; i++) {
		            backdrops[i].parentNode.removeChild(backdrops[i]);
		        }
		    }
		});

		$('#question_money_client_{{tab_id}}').on('hidden.bs.modal', function () {
	    $(this).removeClass('show'); // Asegúrate de que la clase 'show' se elimina
	    $('body').removeClass('modal-open'); // Elimina la clase 'modal-open' del body
	    $('.modal-backdrop').remove(); // Elimina cualquier fondo restante
	    $(".money_client{{tab_id}}").val('')
	    $(".return_money_client{{tab_id}}").val('')
		});

		$('#example_{{tab_id}}').DataTable();
    $(document).on('keydown', function(event) {
        if (event.altKey && event.key.toLowerCase() === 'Escape') {
          $('.modal_list_product_{{tab_id}}').modal('hide');
          $(".product_name_{{tab_id}}").focus()
        }
        else if (event.altKey && event.key.toLowerCase() === 'p') {
          $(".product_name_{{tab_id}}").click()
        }
        else if (event.altKey && event.key.toLowerCase() === 'z') {
          $(".product_name_{{tab_id}}").click()
        }
    });

    $('input[aria-controls="example_{{tab_id}}"]').keydown(function(event) {
    	const table = document.querySelector("#example_{{tab_id}} tbody");
	    const rows = table.querySelectorAll("tr");
	    let focusedRowIndex = 0;
	  	if (event.key === "ArrowDown") {
	  		focusedRowIndex = Math.min(focusedRowIndex + 1, rows.length - 1);
        rows[focusedRowIndex].focus();
        event.preventDefault();
	  	}
		})
    
    $('input[aria-controls="example_{{tab_id}}"]').on('keypress', function(event) {
        if (event.which == 13) {
            table.search('').draw();
        }
    });
  });
	

	$(document).ready(function () {

		loadTableData();
		$(document).on('change','.ci_{{tab_id}}', function() {
			const productIndex = products_{{tab_id|safe}}.findIndex(product =>product.code === id_product_{{tab_id|safe}});
			const product = products_{{tab_id|safe}}[productIndex]
			var __price = parseInt($(".price_{{tab_id}}").val())
	    if ($(this).is(':checked')) {
	        if(__price == 1){
	        	p1 = parseInt($(".price_1_{{tab_id}}").val())
	        	_value_percetage = p1 + (p1 * ( percentages_{{tab_id|safe}} / 100 ) )
	        	$(".price_1_{{tab_id}}").val(_value_percetage)
	        	value_increase{{tab_id|safe}} = _value_percetage * 0.08
	        	console.log(value_increase{{tab_id|safe}})
	        }
	    } else {
	        if(__price == 1){
	        	p1 = parseInt(product['price_1'])
	        	$(".price_1_{{tab_id}}").val(p1)
	        }
	    }
		});

		$(".price_{{tab_id}}").keyup(function(e){
			const code = e.keyCode ? e.keyCode : e.which;
			const productIndex = products_{{tab_id|safe}}.findIndex(product =>product.code === id_product_{{tab_id|safe}});
			product = products_{{tab_id|safe}}[productIndex]
			stock = $(".stock_{{tab_id}}")
			if($(".price_{{tab_id}}").val()){
				if(code == 49 || code == 52){
					stock.val(product['quantity_unit'])
				}
				else if(code == 50 || code == 53){
					stock.val(product['bale_quantity'])
				}
				else if(code == 51 || code == 54){
					stock.val(product['quantity'])
				}
			}

		})

		$(document).on("change",".product_name_{{tab_id}}",function(){
			code_product = $(".product_name_{{tab_id}}").val()
			if(code_product != '0'){
				$.ajax({
	        url: "{% url 'Loading_Product' %}",
	        data: {'code': $(".product_name_{{tab_id}}").val()},
	        success: function (e) {
	          _e = JSON.parse(e);
	          products_{{tab_id|safe}}.push(_e)
	          $(".stock_{{tab_id}}").val(0)
	          id_product_{{tab_id|safe}} = _e['code']
	          $(".product_name_{{tab_id}}").val(_e['name'])
	          $(".price_{{tab_id}}").val('')
	          $(".close_list_product").click();
	          $(".price_{{tab_id}}").focus()
	          $(".price_1_{{tab_id}}").val(parseInt(_e['price_1']))
	          $(".price_2_{{tab_id}}").val(parseInt(_e['price_2']))
	          $(".price_3_{{tab_id}}").val(parseInt(_e['price_3']))
	          $(".price_4_{{tab_id}}").val(parseInt(_e['price_4']))
	          $(".price_5_{{tab_id}}").val(parseInt(_e['price_5']))
	          $(".price_6_{{tab_id}}").val(parseInt(_e['price_6']))
	          percentages_{{tab_id|safe}} = parseInt(_e['percentages'])
	          $('input[aria-controls="example_{{tab_id}}"]').val('')
	          $('input[aria-controls="example_{{tab_id}}"]').trigger($.Event('keypress', { which: 13 }));
	        }
	      })
	    }
		})

		$(document).on('click','.delete_product_row{{tab_id}}', function(e){
			id = this.id
			const existingRow = $(`.row_product_{{tab_id}} td.${id}`).closest("tr");
			_quantity = parseInt(existingRow.find("td:eq(3)").text());
			$(".stock_{{tab_id}}").val(parseInt($(".stock_{{tab_id}}").val()) + _quantity)
			const productIndex = products_{{tab_id|safe}}.findIndex(product => product.code === id);
      products_{{tab_id|safe}}.splice(productIndex, 1);
      $(".product_name_{{tab_id}}").focus()
      $(this).closest('tr').remove();
      $.ajax({
      	url: "{% url 'Return_Product_UNIQUE' %}",
      	data:{'pk_employee':"{{pk_employee}}", "pk_product": id,'quantity':_quantity }
      })
      clearStorage()
      CalculateTotalsInvoice();
      saveTableData();
		})

		$(document).on('keypress',".price_{{tab_id}}", function(e){
			const value = parseInt($(this).val());
      const code = e.keyCode ? e.keyCode : e.which;
      if(code === 13){
      	$(".quantity_{{tab_id}}").focus()
      }
		})


		function recovery_invoice_saved(){
			var totalItems = localStorage.length;
			var local = [];
			for (var i = 0; i < totalItems; i++) {
			  var key = localStorage.key(i);
			  if (key.includes("Headers_{{tab_id}}")) {
			    var value = localStorage.getItem(key);
			    local.push(JSON.parse(value));
			  }
			}
			$(".account_p_{{tab_id}}").val(local.length)
			$('.row_product_local_{{tab_id}}').empty()
		  for(j = 0; j < local.length; j++){
		  	e = local[j]
		  	$('.row_product_local_{{tab_id}}').append(`
		  		<tr>
		  			<td>${e.referens}</td>
		  			<td>${e.date}</td>
		  			<td>${e.total_invoice}</td>
		  		</tr>
		  	`)
			}
		}
		recovery_invoice_saved()

		document.addEventListener('keydown', function(event) {
      if (event.altKey && event.key.toLowerCase() === 'f6') {
		    $(".client_{{tab_id}}").focus()
		    $(".client_{{tab_id}}").click()
		  }
		  else if (event.altKey && event.key.toLowerCase() === 'f7') {
		    $(".referens_{{tab_id}}").focus()
		  }
		  else if (event.altKey && event.key.toLowerCase() === 'f8') {
		    $(".save_account_{{tab_id}}").click()
		  }
		  else if (event.key.toLowerCase() === 'f10') {
		    $(".save_invoice_billing_{{tab_id}}").click()
		    event.preventDefault();
		  }
		  else if (event.altKey && event.key.toLowerCase() === 'q') {
		    $(".quantity_{{tab_id}}").focus()
		  }
		  else if (event.altKey && event.key.toLowerCase() === 'b') {
		    $(".quantity_{{tab_id}}").focus()
		  }
		  else if (event.altKey && event.key.toLowerCase() === 'x') {
		  	$(".recovery_invoice_{{tab_id}}").click()
		  }
    })
		
		function Get_Number(totals){
			if(totals > topemax_{{tab_id|safe}} && !t_d && !omitir_{{tab_id|safe}}){
				res_type_document_{{tab_id|safe}} = 2
				$.notify("Se ha cambiado a facturación electrónica", "info");
				t_d_{{tab_id|safe}} = true
			}
			else if(totals <= topemax_{{tab_id|safe}} && t_d_{{tab_id|safe}}){
				res_type_document_{{tab_id|safe}} = 1
				$.notify("Se ha cambiado a facturación POS", "info");
				t_d_{{tab_id|safe}} = false
			}
			$.ajax({
				url: "{% url 'Get_Number' %}",
				data:{'type_document':res_type_document_{{tab_id|safe}}},
				success:function(e){
					_e = JSON.parse(e)
					$(".sms_resolution").text(_e.days_expiration)
					if(_e.days_expiration_resolution <= 10){
						$(".sms_resolution").addClass("blink")
					}
					else{
						$(".sms_resolution").removeClass("blink")
					}
					if(Object.keys(_e).length > 0){
						$(".number_invoice").text(_e._from)
						prefix_{{tab_id|safe}} = _e.prefix
					}
					if(res_type_document_{{tab_id|safe}} == 2 && Object.keys(_e).length == 0){
						res_type_document_{{tab_id|safe}} = 1
						t_d_{{tab_id|safe}} = false
						omitir_{{tab_id|safe}} = true
						$.notify("Nos mantenemos en facturación POS, por falta de resolucion en factura electrónica", "info");
					}
					else if(res_type_document_{{tab_id|safe}} == 2 && Object.keys(_e).length > 0){
						omitir_{{tab_id|safe}} = false
					}
				}
			})
		}
		setInterval(function() {
      Get_Number(parseInt($(".subtotal").text()))
    }, 1000);

		$(".recovery_invoice_{{tab_id}}").click(function(){
			$(".question_excel_inventory_{{tab_id}}").click()
		})

		$(".client").change(function(){
			$(".quantity_{{tab_id}}").focus()
		})

		$(".items_saved_{{tab_id}}").click(function() {
	    if (event.target.tagName === "TD") {
        var celda = event.target;
        var fila = celda.parentElement;
        var celdas = fila.getElementsByTagName("td");
        var referens = celdas[0].textContent;
        var totalItems = localStorage.length;
        var header = {};
        var items = null;
        for (var i = 0; i < totalItems; i++) {
          var key = localStorage.key(i);
          if (key === "Headers_{{tab_id}}_" + referens) {
              var value = localStorage.getItem(key);
              header = JSON.parse(value);
              items = JSON.parse(localStorage.getItem("Body_{{tab_id}}_" + referens));
              $(".referens_{{tab_id}}").val(referens)
          }
        }
        local_items_saved_{{tab_id|safe}} = true;
        local_row_items_saved = true;
        referens_body = "Body_{{tab_id}}_" + referens;
        referens_header = "Headers_{{tab_id}}_" + referens;
        active_account = true
        for (var i = 0; i < items.length; i++) {
          products_{{tab_id|safe}}.push(items[i]);
          id_product_{{tab_id|safe}} = items[i].pk_product
          value = items[i].quantity
          datos = { 'pk_product': items[i].pk_product,'type_price':1, 'quantity': value }
          $.ajax({            	
            data: datos,
            success: function (e) {
            	console.log(e)
              if (e) {
                UpdateExistingProduct(id_product_{{tab_id|safe}}, value);
						    $(".quantity_{{tab_id}}").focus('')
              } else {
                  alert("Error al reservar el producto");
              }
            },
            error: function(xhr, status, error) {
	            console.log('Error en la solicitud AJAX:', status, error);
		        }
          });
            
        }
        $('.close_invoice_save').click();
        
        localStorage.removeItem(referens_header);
	      localStorage.removeItem(referens_body);
        recovery_invoice_saved()
	    }
		});

		$(".invent_excel_{{tab_id}}").on('hidden.bs.modal', function () {
		  $(".quantity_{{tab_id}}").focus()
		});

    var fechaActual = new Date();
		var fechaActualUTC = new Date();
		var offset = -5 * 60;
		var fechaBogota = new Date(fechaActualUTC.getTime() + offset * 60000);
		$(".date_invoice_{{tab_id}}").val(fechaBogota.toISOString().split('T')[0]);
    $(".due_date_{{tab_id}}").val(fechaBogota.toISOString().split('T')[0]);
    header_{{tab_id|safe}}.date_invoice = $(".date_invoice_{{tab_id}}").val();
    header_{{tab_id|safe}}.due_date = $(".due_date_{{tab_id}}").val();

    $(".paymentform_{{tab_id}}").change(function () {
        const id = parseInt($(this).val());
        $(".due_date_{{tab_id}}").css('display', id === 2 ? 'block' : 'none');
    });

    $(".due_date_{{tab_id}}").change(function () {
        header_{{tab_id|safe}}.due_date = $(this).val();
    });

   	$(document).on("keypress",".quantity_{{tab_id}}",function(e){
   		const value = parseInt($(this).val());
      const code = e.keyCode ? e.keyCode : e.which;
      if(code == 67 || code == 99){
      	$(".client_{{tab_id}}").click()
      	$(this).val('')
      }
      else if(code == 112){
      	if(percentagesactive_{{tab_id|safe}}){
      		percentagesactive_{{tab_id|safe}} = false
      	}
      	else{
      		percentagesactive_{{tab_id|safe}} = true
      	}
      	$('.ci_{{tab_id}}').prop("checked", percentagesactive_{{tab_id|safe}});
      	$('.ci_{{tab_id}}').trigger('change');
      }
      else if(code == 42){
      	$(".save_invoice_billing_{{tab_id}}").click()
      }
      else if(code == 70 || code == 102){
      	Save_Invoice()
      	$(this).val('')
      }
      else if(code == 66 || code == 98){
      	$(this).val('');
	      $(".total_{{tab_id}}").val(0)
      }
      result_query = false
      const stockValue = parseInt($(".stock_{{tab_id}}").val());
      if($(".quantity_{{tab_id}}").val() !== "" && $(".quantity_{{tab_id}}").val() !== null && $(".quantity_{{tab_id}}").val() !== undefined){
	      $.ajax({
	      	url: "{% url 'Validated_Quantity' %}",
	      	data:{"code": id_product_{{tab_id|safe}}, 'type_price':$(".price_{{tab_id}}").val(), 'quantity':$(".quantity_{{tab_id}}").val()},
	      	success: function(e){
	      		e = JSON.parse(e)
	      		console.log(e)
	      		result_query = e.result
	      		stock = $(".stock_{{tab_id}}")
	      		if($(".price_{{tab_id}}").val() == 1 || $(".price_{{tab_id}}").val() == 4){
	      			stock.val(e.quantity_unit)
	      		}else if($(".price_{{tab_id}}").val() == 2 || $(".price_{{tab_id}}").val() == 5){
	      			stock.val(e.bale_quantity)
	      		}
	      		else if($(".price_{{tab_id}}").val() == 3 || $(".price_{{tab_id}}").val() == 6){
	      			stock.val(e.quantity)
	      		}
	      		if (!e.result) {
					    if (value > parseInt(stock.val())) {
					      $(".quantity_{{tab_id}}").val(parseInt(stock.val()));
					    }
						}
	      	}
	      })
	    }
	    if(result_query || value <= parseInt(stock.val())){
	      if (code === 13) {
	        if (value > 0) {
	        	if($(".price_{{tab_id}}").val().trim() !== ''){
	            $.ajax({
	              data: { 'pk_product': id_product_{{tab_id|safe}}, 'quantity': value, 'type_price': $(".price_{{tab_id}}").val()},
	              success: function (e) {
	                if (e) {
	                  UpdateExistingProduct(id_product_{{tab_id|safe}}, value);
	                  $('.stock').val(stockValue - value);	
	                  const stock = parseInt($(".stock_{{tab_id}}").val());
							      if(stock <= limit_stock_{{tab_id}}){
								      $.notify("Hay muy poco productos de stock", "error");
								    }
								    $(".quantity_{{tab_id}}").val('')
	                } else {
	                    alert("Error al reservar el producto");
	                }
	                $(".product_name_{{tab_id}}").click()
	                $(".product_name_{{tab_id}}").val('')
	              }
	            });
	          }else{
	          	$.notify("Debe seleccionar un precio", "error");
	          	$(".price_{{tab_id}}").focus()
	          }
	        }
	      }
	    }else if(!result_query || value >= parseInt(stock.val())){
	    	$.notify("No tiene producto para recargar inventario", "error");
	    }
   	})

   	$(".save_account_{{tab_id}}").click(function(){
    	if($(".referens_{{tab_id}}").val().length >= 5){
	    	console.log(GenerateTableJSON())
	    	headers = Data_Header()
	    	details_invoice = GenerateTableJSON()
	    	localStorage.setItem("Headers_{{tab_id}}_"+$(".referens_{{tab_id}}").val(),headers)
	    	localStorage.setItem("Body_{{tab_id}}_"+$(".referens_{{tab_id}}").val(),details_invoice)
	    	recovery_invoice_saved()
	    	Clean()
	    }
	    else
	    {
	    	noti_person("ERROR", "Debe ingresar un nombre en la referencia");
	    	$(".referens_{{tab_id}}").focus();
	    }
    })

    $(document).on('keyup',".money_client{{tab_id}}", function(e){
    	var keyPressed = e.key
    	if(keyPressed.toLowerCase() == 'i'){
    		if(!imnpoc_{{tab_id|safe}}){
    			$(".form-check-input.impoc{{tab_id}}#flexSwitchCheckChecked").prop("checked", true);
    			imnpoc_{{tab_id|safe}} = true
    		}else{
    			$(".form-check-input.impoc{{tab_id}}#flexSwitchCheckChecked").prop("checked", false);
    			imnpoc_{{tab_id|safe}} = false
    		}
    	}    
    	else if(keyPressed.toLowerCase() == 'f' || keyPressed === 'Enter'){
    		Save_Invoice()
    	}    	
    	var keyCode = e.keyCode || e.which;
    	var key = String.fromCharCode(keyCode);
    	var isNumber = /^\d+$/.test(key);

    	if (!isNumber && !isControlKey(keyCode)) {
    		totals = parseInt($(".total_invoice_{{tab_id}}").text())
	    	value = parseInt( $(".money_client{{tab_id}}").val() ) - totals
	    	$(".return_money_client{{tab_id}}").val(value)
    	}
    })

    function isControlKey(keyCode) {
		    return (keyCode == 8 || keyCode == 9 || keyCode == 13 || keyCode == 27 || keyCode == 46); // Backspace, Tab, Enter, Escape, Delete
		}

    $('#question_money_client_{{tab_id}}').on('shown.bs.modal', function () {
    	total_invoice_ = parseInt($(".total_invoice_{{tab_id}}").text())
    	$(".return_money_client{{tab_id}}").val(total_invoice_)
    	$(".money_client{{tab_id}}").focus()
    })

   	$(".save_invoice_billing_{{tab_id}}").click(function(){
   		$(".question_money_client_{{tab_id}}").click()
   		//Save_Invoice()
   	})

   	$(".save_invoice_billing_elec_{{tab_id}}").click(function(){
	   		res_type_document_{{tab_id|safe}} = 1
	   		Save_Invoice()
	  })

		function Data_Header(){
			return JSON.stringify({
				"pk_employee":"{{pk_employee}}",
				"prefix": prefix_{{tab_id|safe}},
				"pk_customer": (parseInt($(".client_{{tab_id}}").val()) == 0 ) ? 2 : $(".client_{{tab_id}}").val(),
				"date":$(".date_invoice_{{tab_id}}").val(),
				"date_invoice_due":($(".date_invoice_due_{{tab_id}}").val() !== "") ? $(".date_invoice_due_{{tab_id}}").val() : $(".date_invoice_{{tab_id}}").val(),
				"paymentform": isNaN(parseInt($(".paymentform_{{tab_id}}").val())) ? 1 : parseInt($(".paymentform_{{tab_id}}").val()),
				'type_document': res_type_document_{{tab_id|safe}},
				"total_invoice": $(".total_invoice_{{tab_id}}").text(),
				'referens': $(".referens_{{tab_id}}").val(),
				'number': $(".number_invoice_{{tab_id}}").text(),
				'note': ($(".notes_{{tab_id}}").val() === "") ? "No hay observaciones" : $(".notes_{{tab_id}}").val(),
				"state": (res_type_document_{{tab_id|safe}} === 1) ? "Factura POS generada con exito" : "Sin enviar a la DIAN",
				"consumption_tax": imnpoc_{{tab_id|safe}}
			}, null, 2)
		}

		function GenerateTableJSON() {
		    const tableRows = $(".row_product_{{tab_id}} tr");
		    const jsonData = [];
		    tableRows.each(function() {
		        const row = $(this);
		        const pk_product = row.find("td:eq(0)").text();
		        const code = row.find("td:eq(1)").text();
		        const product = row.find("td:eq(2)").text();
		        const quantity = parseInt(row.find("td:eq(3)").text());
		        const type_price = parseInt(row.find("td:eq(4)").text());
		        const price = parseFloat(row.find("td:eq(5)").text());
		        const costo = parseFloat(row.find("td:eq(5)").text());
		        const tax = parseFloat(row.find("td:eq(6)").text());
		        const discount = parseFloat(row.find("td:eq(7)").text());
		        const ipo = parseFloat(row.find("td:eq(8)").text());
		        const totalValue = parseFloat(row.find("td:eq(9)").text());

		        jsonData.push({pk_product,code,product,quantity,type_price,price,costo,tax,discount,ipo,totalValue});
		    });

		    return JSON.stringify(jsonData, null, 2); // Formateo para mejor legibilidad
		}

		function CalculateTotalsInvoice(){
				var filas = $(".row_product_{{tab_id}}").find("tr");
	      var resultado = "";
	      let subtotal_row_table_invoice = 0
	      let impoconsumo = 0
	      let impuestos = 0
				let tax_row_table_invoice = 0
				let discount = 0
				let value_increase = 0
	      for(i=0; i<filas.length; i++){
          var celdas = $(filas[i]).find("td")
          _quantity = parseFloat($(celdas[3]).text())
        	value_increase += parseFloat($(celdas[5]).text()) * _quantity
        	subtotal_row_table_invoice += parseFloat($(celdas[6]).text()) * _quantity
        	impoconsumo += parseFloat($(celdas[9]).text()) * _quantity
        	impuestos += parseFloat($(celdas[7]).text()) * _quantity
        	discount += parseFloat($(celdas[8]).text()) * _quantity
	      }
	      console.log(value_increase)
      	$(".subtotal_{{tab_id}}").text(subtotal_row_table_invoice.toFixed(0))
	      $(".ico_{{tab_id}}").text(impoconsumo.toFixed(0))
	      $('.impuestos_{{tab_id}}').text(impuestos.toFixed(0))
	      $('.descuento_{{tab_id}}').text(discount)
	      let total = impoconsumo + subtotal_row_table_invoice + impuestos + value_increase
	      $(".total_invoice_{{tab_id}}").text(total.toFixed(0))
	      $(".quantity_{{tab_id}}").val('')
	      $(".total_product_{{tab_id}}").val(total.toFixed(0));
	      $('.product_name_{{tab_id}}').val('')
	      $('.product_name_{{tab_id}}').focus()
	      $(".price_{{tab_id}}").val('1')
	      percentagesactive_{{tab_id|safe}} = false
			  $('.ci_{{tab_id}}').prop("checked", false);
	      $('.ci_{{tab_id}}').trigger('change');
		}

		function SelectPrice(obj){
			_price = ['price_1','price_2','price_3','price_4','price_5','price_6']
			return _price[obj]
		}

		function CalculateTaxValue(tax,price_){
			return price_ - (price_ / (1 + ( parseInt(tax) / 100 )))
		}
		
		discount = null

		function CalculateBaseWithDiscount(product){
			type_price = parseInt($(".price_{{tab_id}}").val())
			_price = parseInt($(`.price_${type_price}_{{tab_id}}`).val()) - product['ipo']
			tax = Math.round(CalculateTaxValue(product['tax'], _price))
			base = _price - tax
			discount = ( parseInt($(".discount_{{tab_id}}").val()) > 0 ) ? base * (parseInt($(".discount_{{tab_id}}").val()) / 100) :  base * (product['discount'] / 100)
			return base - discount
		}

		function TotalValue(quantity, tax, base_g, ipo){
			return quantity * (tax + base_g + ipo)
		}

		function Add_Product(_product, quantity) {
			if(!local_items_saved_{{tab_id|safe}}){
		    const ipo = _product['ipo']
		    const base_g = CalculateBaseWithDiscount(_product)		    
		    if(base_g > 0){
			    const tax = CalculateTaxValue(_product)
			    const tax_grabable = (base_g * (parseInt(_product['tax']) / 100))
			    const subtotal = base_g
			    const totalValue = TotalValue(quantity,tax_grabable,base_g, ipo)
			    const _type_price = $(".price_{{tab_id}}").val()
			    console.log(_product['ipo']+'Ipo')
			    $(".row_product_{{tab_id}}").append(`
			        <tr>
			            <td hidden class="${_product.code}">${_product.code}</td>
			            <td class="${_product.code}">${_product.code}</td>
			            <td>${_product.name}</td>
			            <td class="text-center">${quantity}</td>
			            <td>${_type_price}</td>
			            <td>${value_increase{{tab_id|safe}}}</td>
			            <td>${base_g.toFixed(0)}</td>
			            <td>${tax_grabable.toFixed(0)}</td>
			            <td>${discount.toFixed(0)}</td>
			            <td>${_product['ipo']}</td>
			            <td>${subtotal.toFixed(0)}</td>
			            <td>${totalValue.toFixed(0)}</td>
			            <td class"text-center"><span class="fas fa-trash-alt delete_product_row{{tab_id}}" id="${_product.code}"></span></td>
			        </tr>
			    `);
			    type_price = $(".price_{{tab_id}}").val()
			  }
			  else{
			  	$.notify("No puede facturar en cero", "error");
			  }
		  }
		  else{
		  	console.log(_product+' Product')
		  	console.log(_product.length + ' Len Product')
		  	// for(i = 0; i < _product.length; i++){
		  	const baseWithDiscount =  _product[i].price
		    const taxValue = _product[i].tax
		    const totalValue = _product[i].totalValue
		    const subtotal = _product[i].price * _product[i].quantity
		    $(".row_product_{{tab_id}}").append(`
		        <tr>
		            <td hidden class="${_product[i].pk_product}">${_product[i].pk_product}</td>
		            <td class="${_product[i].code}">${_product[i].code}</td>
		            <td>${_product[i].product}</td>
		            <td class="text-center">${quantity}</td>
		            <td>${_product[i].type_price}</td>
		            <td>${baseWithDiscount}</td>
		            <td>${taxValue}</td>
		            <td>${_product[i].discount}</td>
		            <td>${_product[i].ipo}</td>
		            <td>${subtotal.toFixed(2)}</td>
		            <td>${totalValue}</td>
		            <td class"text-center"><span class="fas fa-trash-alt delete_product_row{{tab_id}}" id="${_product[i].code}"></span></td>
		        </tr>
		    `);
			  // }
		  }
		  $(".stock_{{tab_id}}").val(parseInt($(".stock_{{tab_id}}").val()) - quantity)
		  CalculateTotalsInvoice();
		  saveTableData()
		}

		function UpdateExistingProduct(pk_product, quantity) {
		    const existingRow = $(`.row_product_{{tab_id}} td.${pk_product}`).closest("tr");
		    if (existingRow.length > 0) {
	        const existingQuantity = parseInt(existingRow.find(".text-center").text());
	        const newQuantity = existingQuantity + quantity;
	        if (newQuantity > 0) {
	          existingRow.find(".text-center").text(newQuantity);
	          const productIndex = products_{{tab_id|safe}}.findIndex(product =>product.code === pk_product);
	          if (productIndex !== -1) {
	            const product = products_{{tab_id|safe}}[productIndex];
	            _quantity = parseInt(existingRow.find("td:eq(3)").text());
	            _base_g = parseInt(existingRow.find("td:eq(4)").text());
	            _subtotal = _quantity * _base_g;
	            existingRow.find("td:eq(8)").text(_subtotal);
	            $(".stock_{{tab_id}}").val(parseInt($(".stock_{{tab_id}}").val()) - quantity)
	            // $(".stock_{{tab_id}}").val(parseInt($(".stock_{{tab_id}}").val()) + (quantity < 0) ?  Math.abs(quantity) : 0 )
	            CalculateTotalsInvoice();
	            saveTableData()
	          }
	        } else {
	          existingRow.remove();
	          const productIndex = products_{{tab_id|safe}}.findIndex(product => product.code === pk_product);
	          products_{{tab_id|safe}}.splice(productIndex, 1);
	          CalculateTotalsInvoice();
	          $.ajax({
	          	url:"{% url 'Return_Products' %}"
	          })
	          $(".product_{{tab_id}}").click()
	          $(".stock_{{tab_id}}").val(0)
	        }
		    } else {
		        Add_Product(products_{{tab_id|safe}}.find(product => product.code === pk_product), quantity);
		    }
		}

		function Save_Invoice() {
	    $('#question_money_client_{{tab_id}}').modal('hide');
	    $(".loader_{{tab_id}}").click();
	    $.ajax({
	        url: "{% url 'Save_Invoice' %}",
	        method: "POST",
	        data: {
	            csrfmiddlewaretoken: '{{ csrf_token }}',
	            'headers': Data_Header(),
	            'details_invoice': GenerateTableJSON()
	        },
	        success: function(response) {
	            try {
	                const e = JSON.parse(response);
	                console.log(e);
	                if (e.result) {
	                    localStorage.removeItem(referens_header_{{tab_id|safe}});
	                    localStorage.removeItem(referens_body_{{tab_id|safe}});
	                    recovery_invoice_saved();
	                    
	                    // Configuración y apertura de la ventana emergente para la impresión
	                    let screenWidth = window.screen.width;
	                    let screenHeight = window.screen.height;
	                    let windowWidth = 800;
	                    let windowHeight = 600;
	                    let leftPosition = (screenWidth - windowWidth) / 2;
	                    let topPosition = (screenHeight - windowHeight) / 2;
	                    let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;
	                    let printWindow = window.open("{{request.session.url}}/invoice/Print_Invoice/" + e.pk_invoice, "invoice", params);

	                    if (printWindow) {
	                        printWindow.onload = function() {
	                            printWindow.document.body.style.zoom = "100%";
	                            printWindow.print();
	                            printWindow.onafterprint = function () {
	                                printWindow.close();
	                            };
	                        };
	                    }

	                    $.ajax({
	                        url: "{% url 'Send_Email_DIAN' %}",
	                        data: { "pk_invoice": e.pk_invoice },
	                        success: function(emailResponse) {
	                            const emailResult = JSON.parse(emailResponse);
	                            if (emailResult.result) {
	                                noti_person(emailResult.message, "Tarea Finalizada");
	                            } else {
	                                noti_person(emailResult.message, "Error en la solicitud");
	                            }
	                        },
	                        error: function() {
	                            noti_person('Error al enviar el correo', 'Error');
	                        }
	                    });

	                    Clean();
	                    $("#loader1_{{tab_id}}").modal("hide");
	                } else {
	                    noti_person('ERROR', e.message);
	                    $(".quantity_{{tab_id}}").val('');
	                    $("#loader1_{{tab_id}}").modal("hide");
	                }
	            } catch (err) {
	                console.error('Error en el procesamiento de la respuesta:', err);
	                noti_person('Error de procesamiento', 'ERROR');
	                $("#loader1_{{tab_id}}").modal("hide");
	            }
	        },
	        error: function(xhr, status, error) {
	            console.log('Error en la solicitud AJAX:', status, error);
	            noti_person('Error en la solicitud', 'ERROR');
	            $("#loader1_{{tab_id}}").modal("hide");
	        }
	    });
		    $('#question_money_client_{{tab_id}}').modal('hide');
		    // $(".loader_{{tab_id}}").click()
		    $.ajax({
		        url: "{% url 'Save_Invoice' %}",
		        method: "POST",
		        data: {
		            csrfmiddlewaretoken: '{{ csrf_token }}',
		            'headers': Data_Header(),
		            'details_invoice': GenerateTableJSON()
		        },
		        success: function(e) {
	            e = JSON.parse(e)
	            console.log(e)
	            if (e.result) {
	                localStorage.removeItem(referens_header_{{tab_id|safe}});
	                localStorage.removeItem(referens_body_{{tab_id|safe}});
	                recovery_invoice_saved();

	                // Configurar la ventana emergente para la factura como antes
	                let screenWidth = window.screen.width;
									let screenHeight = window.screen.height;
									let windowWidth = 800;
									let windowHeight = 600;
									let leftPosition = (screenWidth - windowWidth) / 2;
									let topPosition = (screenHeight - windowHeight) / 2;
									let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;
									let printWindow = window.open("{{request.session.url}}/invoice/Print_Invoice/" + e.pk_invoice, "invoice", params);
									if (printWindow) {
									  printWindow.onload = function() {
									    printWindow.document.body.style.zoom = "100%";
									    printWindow.print();
									    printWindow.onafterprint = function () {
									      printWindow.close();
									    };
									  };
									}


	                // Llamar a la función para imprimir con QZ Tray
	                // imprimirConQZ(e.pk_invoice);
	                recovery_invoice_saved()
	                Clean();
	                $("#loader1_{{tab_id}}").modal("hide");
	                $.ajax({
						        url:"{% url 'Send_Email_DIAN' %}",
						        data:{"pk_invoice":e.pk_invoice},
						        success: function(e){
						          e = JSON.parse(e)
						          if(e.result){
						            noti_person(e.message, "Tarea Finalizada");
						          }
						          else{
						            noti_person(e.message, "Error en la solicitud");
						          }
						        }
						      })

	            } else {
	                noti_person('ERROR', e.message);
	                $(".quantity_{{tab_id}}").val('');
	            }
		        }
		    });
		}


		// Función para manejar la impresión con QZ Tray
		function imprimirConQZ(invoice_id) {
		    // Asegurarse de que QZ Tray esté conectado
		    qz.websocket.connect().then(() => {
		        let config = qz.configs.create("Nombre_de_la_impresora"); // Configura el nombre de la impresora

		        // Generar los datos de la factura a imprimir
		        let data = [{
		            type: 'raw',
		            format: 'plain',
		            data: 'Factura ID: ' + invoice_id + '\n\nDetalles de la factura aquí...\n'
		        }];

		        // Enviar los datos a la impresora
		        qz.print(config, data).then(() => {
		            console.log("Impresión completada.");
		        }).catch((err) => {
		            console.error("Error al imprimir:", err);
		        });

		    }).catch((err) => {
		        console.error("Error al conectar con QZ Tray:", err);
		    });
		}


		function Clean(){
			clearStorage()
			$('.date_invoice_due_{{tab_id}}').val('')
      $(".row_product_{{tab_id}}").empty()
			$(".subtotal_{{tab_id}}").text(0)
      $(".ico_{{tab_id}}").text(0)
      $('.impuestos_{{tab_id}}').text(0)
      $('.descuento_{{tab_id}}').val(0)
      $(".total_invoice_{{tab_id}}").text(0)
      $(".quantity_{{tab_id}}").val(0)
      $(".total_product_{{tab_id}}").val(0)
      $('.product_name_{{tab_id}}').val('')
      $('.stock_{{tab_id}}').val('')
      $('.referens_{{tab_id}}').val('')
      $('.product_name_{{tab_id}}').focus()

      $(".price_1_{{tab_id}}").val('')
      $(".price_2_{{tab_id}}").val('')
      $(".price_3_{{tab_id}}").val('')
      $(".price_4_{{tab_id}}").val('')
      $(".price_5_{{tab_id}}").val('')
      $(".price_6_{{tab_id}}").val('')

      products_{{tab_id|safe}} = [];
		  local_items_saved_{{tab_id|safe}} = false
		  local_row_items_saved_{{tab_id|safe}} = false
		  referens_header_{{tab_id|safe}} = null
		  referens_body_{{tab_id|safe}} = null
		  header_{{tab_id|safe}} = new Object();
		  id_product_{{tab_id|safe}} = null;
		  active_account_{{tab_id|safe}} = false
		  prefix_{{tab_id|safe}} = null
		  res_type_document_{{tab_id|safe}} = 1
		  t_d_{{tab_id|safe}} = false
		  omitir_{{tab_id|safe}} = false
		}


		function saveTableData() {
	    let tableData = [];
	    $(".row_product_{{tab_id}} tr").each(function () {
	    		console.log($(this))
	        let row = {
	            code: $(this).find("td:eq(1)").text(),
	            name: $(this).find("td:eq(2)").text(),
	            quantity: $(this).find("td:eq(3)").text(),
	            base: $(this).find("td:eq(4)").text(),
	            tax: $(this).find("td:eq(5)").text(),
	            discount: $(this).find("td:eq(6)").text(),
	            ipo: $(this).find("td:eq(7)").text(),
	            subtotal: $(this).find("td:eq(8)").text(),
	            totalValue: $(this).find("td:eq(9)").text()
	        };
	        if(!row.type_price){
	        	row['type_price'] = type_price
	        }
	        tableData.push(row);
	    });
	    localStorage.setItem('invoiceData_{{tab_id}}', JSON.stringify(tableData));
		}

		async function sendProductData(row) {
		    return new Promise((resolve, reject) => {
		        $.ajax({
		            data: { 
		                'pk_product': row.code, 
		                'quantity': row.quantity, 
		                'type_price': row.type_price,
		                'unique': row.type_price
		            },
		            success: function (e) {
		                console.log(e + ' Response');
		                resolve();  // Resuelve la promesa cuando la solicitud es exitosa
		            },
		            error: function (xhr, status, error) {
		                console.error("Error for product code:", row.code, error);	
		                reject(error);  // Rechaza la promesa si hay un error
		            }
		        });
		    });
		}

		async function loadTableData() {
		    let storedData = localStorage.getItem('invoiceData_{{tab_id}}');
		    if (storedData) {
		        let tableData = JSON.parse(storedData);
		        for (let row of tableData) {
		            $(".row_product_{{tab_id}}").append(`
		                <tr>
		                    <td hidden class="${row.code}">${row.code}</td>
		                    <td class="${row.code}">${row.code}</td>
		                    <td>${row.name}</td>
		                    <td class="text-center">${row.quantity}</td>
		                    <td class="text-center">${row.type_price}</td>
		                    <td>${parseFloat(row.base).toFixed(2)}</td>
		                    <td>${parseFloat(row.tax).toFixed(2)}</td>
		                    <td>${parseFloat(row.discount).toFixed(2)}</td>
		                    <td>${row.ipo}</td>
		                    <td>${parseFloat(row.subtotal).toFixed(2)}</td>
		                    <td>${parseFloat(row.totalValue).toFixed(2)}</td>
		                    <td class="text-center"><span class="fas fa-trash-alt delete_product_row{{tab_id}}" id="${row.code}"></span></td>
		                </tr>
		            `);
		            
		            try {
		              await sendProductData(row);
		            } catch (error) {
		              console.error("Failed to send data for product:", row.code, error);
		            }
		        }
		        CalculateTotalsInvoice();
		    }
		}

		function updateTableAndSave() {
	    // Actualiza la tabla (por ejemplo, después de eliminar una fila)
	    saveTableData(); // Guarda los datos actualizados
		}

		function clearStorage() {
			console.log('invoiceData_{{tab_id}}')
		  localStorage.removeItem('invoiceData_{{tab_id}}');
		}




	});

</script>
